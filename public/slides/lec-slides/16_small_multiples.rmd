---
title: "Small multiples, working with facets"
author: 
    - "Aitor Ameztegui"
date: "Fall 2021"

output:
  xaringan::moon_reader:
    css: "slides.css"
    logo: img/udl_logo.png
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---
  
```{r setup, include=FALSE}
# R options
options(
  htmltools.dir.version = FALSE, # for blogdown
  show.signif.stars = FALSE,     # for regression output
  warm = 1
)
# Set dpi and height for images
library(knitr)
opts_chunk$set(warnings = F, message = F) 
# ggplot2 color palette with gray
color_palette <- list(gray = "#999999", 
                      salmon = "#E69F00", 
                      lightblue = "#56B4E9", 
                      green = "#009E73", 
                      yellow = "#F0E442", 
                      darkblue = "#0072B2", 
                      red = "#D55E00", 
                      purple = "#CC79A7")
```

```{r echo=FALSE, message=FALSE, warning=FALSE, include = FALSE}
library(tidyverse)
library(sf)
library(rgdal)
fires <- read.csv('data/fires.csv')
grid <- read_sf('data/Fires_grid_CCAA.shp')
```

# *'Small multiples'* using `facets`

Faceting (aka small multiples) allows us to create multiple sub plots. It partitions a plot into a matrix of panels with each panel showing a different subset of data.

> *Small multiples* are a powerful tool for exploratory data analysis: you can rapidly compare patterns in different parts of the data and see whether they are the same or different. This section will discuss how you can fine-tune facets, particularly the way in which they interact with position scales. 

---

# *'Small multiple'* using `facets`

- `facet_wrap(~group)`: we create as many groups as levels in the `group`.
`facet_wrap()` makes a long ribbon of panels (generated by any number of variables) and wraps it into 2d.

- `facet_grid(group1~group2)`: we create as many groups as combinations of levels in the two `groups`. `facet_grid` seeks a similar purpose but allowing us to pass two groups so that we can explore the interaction between two factors.

---

# `facet_wrap`

Regular plot as we have seen so far:

```{r, eval=FALSE}
fires %>%
  group_by(CAUSE,MONTH) %>%
    ggplot(aes(x=log(BAREA))) +
      geom_histogram()
```

---

# `facet_wrap`

*Faceting* into individual plots by month:

```{r, echo = FALSE}
fires %>%
  group_by(MONTH) %>%
    ggplot(aes(x=log(BAREA))) +
        geom_histogram() +
        facet_wrap(~MONTH)
```


---

# `facet_grid`

`facet_grid` seeks a similar purpose but allowing us to pass two groups so that we can explore the interaction between two factors. For instace, cause and month:

```{r, eval=F}
fires %>%
    group_by(CAUSE,MONTH) %>%
    ggplot(aes(x=log(BAREA))) +
        geom_histogram() +
        facet_grid(CAUSE~MONTH)
```
---

# `facet_grid`

```{r, echo=F}
fires %>%
    group_by(CAUSE,MONTH) %>%
    ggplot(aes(x=log(BAREA))) +
        geom_histogram() +
        facet_grid(CAUSE~MONTH)
```

---

# Playing with facets, groups and data

At this stage we have plenty of tools to start *being creative*. This is just an example following one of Wilke's suggestions on how to *improve the message*:

```{r, eval=F}
fires %>%
  group_by(CAUSE) %>%
  ggplot() +
  geom_histogram(data=dplyr::select(fires,-CAUSE), aes(x=log(BAREA)),fill='lightgrey') + #all fires without MONTH
  geom_histogram(aes(x=log(BAREA))) +
  facet_wrap(~CAUSE)
```

---

```{r, echo=F}
fires %>%
  group_by(CAUSE) %>%
  ggplot() +
  geom_histogram(data=dplyr::select(fires,-CAUSE), aes(x=log(BAREA)),fill='lightgrey') + #all fires without MONTH
  geom_histogram(aes(x=log(BAREA))) +
  facet_wrap(~CAUSE)
```

---

# Set the facet free

When using `facets` axis limits get *locked* by default. Occasionlly, we might need to use specific data ranges in our plots. To do so, we can set the `scales` option within `facet` to:
  
  - *free*: both x and y axes are adapted to the data in each facet:
  - *free_y*: y axis is adapted automatically.
  - *free_x*: x axis is adapted automatically.
  
---

```{r, echo=F}
fires %>%
  mutate(C = recode(CAUSE, '1' = 'Lightning', 
                        '2' = 'Accident',
                        '3' = 'Negligence',
                        '4' = 'Arson',
                        '5' = 'Unknown',
                        '6' = 'Restarted')) %>%
  group_by(C) %>%
  ggplot() +
  geom_histogram(data=fires, aes(x=log(BAREA)),fill='lightgrey') + #all fires without MONTH
  geom_histogram(aes(x=log(BAREA))) +
  facet_wrap(~C)
```

---

```{r, eval=F}
fires %>%
  mutate(C = recode(CAUSE, '1' = 'Lightning', 
                        '2' = 'Accident',
                        '3' = 'Negligence',
                        '4' = 'Arson',
                        '5' = 'Unknown',
                        '6' = 'Restarted')) %>%
  mutate(C=fct_relevel(C,"Lightning","Accident","Negligence","Arson","Unknown","Restarted")) %>%
  group_by(C) %>%
  ggplot() +
  geom_histogram(data=fires, aes(x=log(BAREA)),fill='lightgrey') + #all fires without MONTH
  geom_histogram(aes(x=log(BAREA))) +
  facet_wrap(~C)
```
---

```{r, echo=F}
fires %>%
  mutate(C = recode(CAUSE, '1' = 'Lightning', 
                        '2' = 'Accident',
                        '3' = 'Negligence',
                        '4' = 'Arson',
                        '5' = 'Unknown',
                        '6' = 'Restarted')) %>%
  mutate(C=fct_reorder(C,CAUSE)) %>%
  group_by(C) %>%
  ggplot() +
  geom_histogram(data=fires, aes(x=log(BAREA)),fill='lightgrey') + #all fires without MONTH
  geom_histogram(aes(x=log(BAREA))) +
  facet_wrap(~C)
```
---

# Theming up!

```{r, eval=F}
fires %>%
  mutate(C = recode(CAUSE, '1' = 'Lightning', 
                        '2' = 'Accident',
                        '3' = 'Negligence',
                        '4' = 'Arson',
                        '5' = 'Unknown',
                        '6' = 'Restarted')) %>%
  mutate(C=fct_reorder(C,CAUSE)) %>%
  group_by(C) %>%
  ggplot() +
  geom_histogram(data=fires, aes(x=log(BAREA)),fill='lightgrey') + #all fires without MONTH
  geom_histogram(aes(x=log(BAREA))) +
  facet_wrap(~C) +
  theme_minimal()
```

---

# Theming up!

```{r, echo=F, warning=F,message=F}
fires %>%
  mutate(C = recode(CAUSE, '1' = 'Lightning', 
                        '2' = 'Accident',
                        '3' = 'Negligence',
                        '4' = 'Arson',
                        '5' = 'Unknown',
                        '6' = 'Restarted')) %>%
  mutate(C=fct_reorder(C,CAUSE)) %>%
  group_by(C) %>%
  ggplot() +
  geom_histogram(data=fires, aes(x=log(BAREA)),fill='lightgrey') + #all fires without MONTH
  geom_histogram(aes(x=log(BAREA))) +
  facet_wrap(~C) +
  theme_minimal()
```

---

# Playing with axes

```{r,eval=F}
fires %>%
  mutate(C = recode(CAUSE, '1' = 'Lightning', 
                        '2' = 'Accident',
                        '3' = 'Negligence',
                        '4' = 'Arson',
                        '5' = 'Unknown',
                        '6' = 'Restarted')) %>%
  mutate(C=fct_reorder(C,CAUSE)) %>%
  group_by(C) %>%
  ggplot() +
  geom_histogram(data=fires, aes(x=BAREA),fill='lightgrey') + #all fires without MONTH
  geom_histogram(aes(x=BAREA)) +
  scale_x_continuous(trans = 'log') +
  facet_wrap(~C) +
  theme_minimal()
```
---

# Playing with axes

```{r,eval=F,warning=F,message=F}
fires %>%
  mutate(C = recode(CAUSE, '1' = 'Lightning', 
                        '2' = 'Accident',
                        '3' = 'Negligence',
                        '4' = 'Arson',
                        '5' = 'Unknown',
                        '6' = 'Restarted')) %>%
  mutate(C=fct_reorder(C,CAUSE)) %>%
  group_by(C) %>%
  ggplot() +
  geom_histogram(data=fires, aes(x=BAREA),fill='lightgrey') + #all fires without MONTH
  geom_histogram(aes(x=BAREA)) +
  scale_x_continuous(trans = 'log') +
  facet_wrap(~C) +
  theme_minimal()
```
---

# Final teaser for what's going next

```{r, eval=F}
fires %>%
  mutate(C = recode(CAUSE, '1' = 'Lightning', 
                        '2' = 'Accident',
                        '3' = 'Negligence',
                        '4' = 'Arson',
                        '5' = 'Unknown',
                        '6' = 'Restarted')) %>%
  mutate(C=fct_reorder(C,CAUSE)) %>%
  group_by(C) %>%
  ggplot() +
  geom_histogram(data=fires, aes(x=BAREA),fill='lightgrey',alpha=0.5) + #all fires without MONTH
  geom_histogram(aes(x=BAREA,fill=C),color='white') +
  scale_x_continuous(trans = 'log',expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) +
  scale_fill_brewer(palette = 'Set2',name='') +
  labs(y='Number of fires',x='log-Burned area') +
  facet_wrap(~C) +
  theme_bw() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_line(linetype = 2, color='gray20'))
```

---

```{r,eval=F,warning=F,message=F}
fires %>%
  mutate(C = recode(CAUSE, '1' = 'Lightning', 
                        '2' = 'Unintended',
                        '3' = 'Unintended',
                        '4' = 'Arson',
                        '5' = 'Unknown',
                        '6' = 'Restarted')) %>%
  filter(CAUSE!=6) %>%
  mutate(C=fct_reorder(C,CAUSE)) %>%
  group_by(C) %>%
  ggplot() +
  geom_histogram(data=fires, aes(x=BAREA),fill='lightgrey',alpha=0.5) + #all fires without MONTH
  geom_histogram(aes(x=BAREA,fill=C),color='white') +
  scale_x_continuous(trans = 'log2',expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) +
  scale_fill_brewer(palette = 'Set2',name='') +
  labs(y='Number of fires',x='log-transformed burned area (ha)') +
  facet_wrap(~C) +
  theme_bw() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_line(linetype = 2, color='gray20'))
```