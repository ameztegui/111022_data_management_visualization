---
title: "Data transformation (I): Create new variables, filter, select and organize data"
date: "111022 | Data management and visualization with R"
author: 
  - "Aitor Ameztegui"
  - "Marcos Rodrigues"
output:
  rmdformats::readthedown:
    highlight: pygments
    number_sections: true
    css: lab.css
# runtime: shiny_prerendered
---

```{r include=FALSE}
library(tidyverse)
library(knitr)
options(
  htmltools.dir.version = FALSE, # for blogdown
  show.signif.stars = FALSE,     # for regression output
  digits = 2
  )
#knitr::opts_chunk$set(eval = FALSE)
load('data/data_IFN.Rdata')
```













##2 PIPES!!!!

## Targeted summaries

### `summarise_if` and `summarise_at`

We can apply a summarising function to a group of variables that share some commmon characteristics that can be tested (i.e. numeric variables).

1. `summarise_if` applies the selected function to those variables that meet a condition. For instance, we can get the `mean` of any variable (columnn) containting numerical data:

```{r summarise_if}
summarise_if(trees, is.numeric, mean)
```

2. With `summarise_at` we can limit the summary by name or using the select helpers (`starts_with`, `ends_with`, `one_of`). 

```{r summarise_at}
summarise_at(trees, vars(starts_with('Diam')), mean)
```


## Targeted transformations

The same targeting approaches can be used with `mutate`:

1. Log-transform those columns containing numerical variable:
```{r mutate_if}
mutate_if(trees, is.numeric, log)
```

2. Recode certain variables. Add *sp_* before the corresponding species code:
```{r mutate_at}
mutate_at(
  trees, vars(one_of(c('Especie', 'Species'))),
  ~ paste0('sp_', .x)
)
```

**Exercise 6**

```
Create pipelines to answer the following questions:

  6.1 Which **plots** have the fastest average growth rate?
  
  6.2 Which is the plot with the **most species**?
  
  6.3 Is there any **relationship** between both variables? <br>
  *(Optional, some knowledge on `ggplot`is required)*
```
## Grouped `mutate`/`filter`

We will commonly use groups (`group_by`) when summarising variables (*n* inputs, one output):

```r
group_by(Especie) %>% summarise(mean = mean(Diam))
```

![](images/04-data-transformation/summary_function.png){width=250px}

Sometimes, however, we may be interested in calculating new variables by group, but without reducing the dimensions:

![](images/04-data-transformation/window_function.png){width=250px}

1. In this example we calculate the difference between the diameter of each tree and the average value of the trees of the same species. `DiamIf3` is taken rowwise whereas the `mean` is calculated at species (*Especie*) level thanks to `group_by`. 

```{r eval = F}

trees %>%
  group_by(Especie) %>%
  mutate(
    std_diam = DiamIf3 - mean(DiamIf3)
  )
```

```{r echo=F}
options(width=100)
trees %>%
  group_by(Especie) %>%
  mutate(
    std_diam = DiamIf3 - mean(DiamIf3)
  )
```


**Exercise 7**
```
  7.1 Identify those trees that grew most as compared to the average in that plot <br>
  .font80[(Hint: calculate growth, *then* mean growth by plot, and *then* the difference)]
  
  7.2 Identify those plots where a species grows much more than the average for the species
```

**Extra (in case you get bored):**  

```
  7.3 Select IFN plots with pure Pinus nigra stands (Especie = 025). Note: we consider a forest to be monospecific when > 80% in BA corresponds to a single species
```
