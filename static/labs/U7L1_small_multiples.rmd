---
title: "Lab 7.1 - Small multiples, working with facets"
date: "111022 | Data management and visualization with R"
author: 
  - "Aitor Ameztegui"
bibliography: "references/biblio.bib"
output:
  rmdformats::readthedown:
  highlight: pygments
number_sections: true
css: lab.css
# runtime: shiny_prerendered
---
  
  
```{r knitr_init, echo=FALSE, cache=FALSE, warning=FALSE}

library(knitr)

## Global options
options(max.print="75")
opts_chunk$set(echo=TRUE,
               cache=FALSE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
```


```{r include=FALSE}
library(tidyverse)

options(
  htmltools.dir.version = FALSE, # for blogdown
  show.signif.stars = FALSE     # for regression output
)
load('data/data_SNFI3.Rdata')
pines <- trees %>% filter(Species %in% c("021","022","023","024","025","026","027","028")) 

```


So far we have learnt how to deal with categorical data or gruops of observations by mapping a discrete variable into an appropriate aesthetic (color, shape...). Yet, we have also encountered limitations on that approach, mainly related to the complexity of visualizing too much information at once. Having too many groups, too many observations or both is usually a major concern.

Faceting (aka small multiples) allows us to create multiple sub plots. A `facet` partitions a plot into a matrix of panels with each panel showing a different subset of the data.

> **Small multiples** are a powerful tool for exploratory data analysis: you can rapidly compare patterns in different parts of the data and see whether they are the same or different. This section will discuss how you can fine-tune facets, particularly the way in which they interact with position scales. 

From an operational standpoint implementing a `facet` split it's simple. We have two funtions:

- `facet_wrap(~group)`: we create as many panels as levels in the `group`
- `facet_grid(group1~group2)`: we create as many groups as combinations of levels in the two `groups`.

# `facet_wrap()`

`facet_wrap()` makes a long ribbon of panels (generated by any number of variables) and wraps it into 2d. This is useful if you have a single variable with many levels and want to arrange the plots in a more space efficient manner.
For example, wwe can break the figure with number of trees per diameter class and species...

```{r}
pines %>%
    group_by(DC, Species) %>%
    summarise(N = sum(N)) %>%
    ggplot() + 
    geom_col(aes(x= DC, y = N))
```

Into a set of histograms based on a category or gruop. For instance, by species:

```{r}
pines %>%
    group_by(DC, Species) %>%
    summarise(N = sum(N)) %>%
    ggplot() + 
    geom_col(aes(x= DC, y = N, fill = Species)) +
    facet_wrap(~Species)
```
We could also use it to represent the relationship between diameter and height for each species:

```{r}
ggplot(pines) +
    geom_point(aes(x= DBH_3, y = Height_3)) +
    facet_wrap(~Species)
```

As you can see, this is quite powerfull. Not only makes the plot more appealing but it enhances the visualization in the sense of improving our perception of the phenomena. Now we can clearly see how the diameter distribution changes for each species.

## Manipulating the arrangement

In `facet_wrap()` we can change the disposition of the plots in several ways. You can control how the ribbon is wrapped with `ncol` and `nrow`, which control how many (e.g., `ncol = 3`) columns and rows you want to display (you only need to set one). `dir` controls the direction of wrap: horizontal or vertical.


```{r}
pines %>%
    group_by(DC, Species) %>%
    summarise(N = sum(N)) %>%
    ggplot() + 
    geom_col(aes(x= DC, y = N, fill = Species)) +
    facet_wrap(~Species, ncol = 2)
```

We can also see that `ggplot2` defines by default a common scale for all panels. This is interesting for comparing values, but if we have important range differences, some values will not be seen. We can modify the `scales` option to `free`, `free_x` and `free_y`:

  - *free*: both x and y axes are adapted to the data in each facet:
  - *free_y*: y axis is adapted automatically.
  - *free_x*: x axis is adapted automatically.

```{r}
pines %>%
    group_by(DC, Species) %>%
    summarise(N = sum(N)) %>%
    ggplot() + 
    geom_col(aes(x= DC, y = N, fill = Species)) +
    facet_wrap(~Species, ncol = 4, scales = "free_y")
```

# `facet_grid()`

`facet_grid` seeks a similar purpose but allowing us to pass two grouping variables, so that we can explore the interaction between two factors. For instace, species and province:

```{r}
pines %>%
    group_by(DC, Species, Province) %>%
    summarise(N = sum(N)) %>%
    ggplot() + 
    geom_col(aes(x= DC, y = N, fill = Species)) +
    facet_grid(Species ~ Province)
```

However, we must be careful when `faceting`. In the above example perhaps we went too far in terms of the resulting number of groups, especially because some combinations do not exist

> The order in which we pass the groups into `facet_grid` determines the arrangment of the subplots (right - cols & left - rows).

> The arrangement and labels of `facet`'s panels depends on the levels of the variable we use. To control or reorder how them we must change the actual levels of the variable as we saw when working with the `forcats` package.


## Working with several `geoms`
3
So far we have covered the necessary contents to implement facets. Nonetheless, it's up to us to decide the ultimate information that goes into a plot. The examples we went through comprise a single `geom` layer. At this stage it suffices to say we can add as many layers as we need and the ggplot will do the rest:

```{r}
ggplot(pines, aes(x= DBH_3, y = Height_3)) +
    geom_point() +
    geom_smooth(aes(color = Species)) +
    facet_wrap(~Species)
```

```{r}
ggplot(pines, aes(x= DBH_3, y = Height_3)) +
    geom_bin_2d() +
    geom_smooth(aes(color = Species)) +
    facet_wrap(~Species)
```

::: exercise :::

**EXERCISE 1** </br>
Use the facets to generate a representation of the number of fires per month for each of the causes. Modify the `facet_wrap()` and/or `facet_grid()` options to achieve the best possible visualisation.
:::

